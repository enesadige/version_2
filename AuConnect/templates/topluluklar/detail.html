{% extends 'layout.html' %}
{% load static %}

{% block content %}
<style>
    .community-header {
        display: flex;
        gap: 20px;
        padding: 20px;
        background-color: var(--dark-bg);
        border-radius: var(--border-radius);
        margin-bottom: 20px;
    }
    
    .community-img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        overflow: hidden;
        background-color: var(--light-bg);
    }
    
    .community-img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .community-info {
        flex: 1;
    }
    
    .community-name {
        font-size: 24px;
        color: var(--text-light);
        margin-bottom: 5px;
    }
    
    .follow-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        transition: all 0.2s ease;
    }
    
    .follow-btn.following {
        background-color: transparent;
        border: 1px solid var(--text-muted);
        color: var(--text-light);
    }
    
    .follow-btn:hover {
        background-color: var(--accent-color);
    }
    
    .follow-btn.following:hover {
        background-color: rgba(255, 0, 0, 0.1);
        border-color: #ff5252;
        color: #ff5252;
    }
    
    .community-stats {
        display: flex;
        align-items: center;
        color: var(--text-muted);
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .community-description {
        color: var(--text-muted);
        line-height: 1.6;
        font-size: 14px;
    }
    
    .posts-section {
        margin-top: 30px;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 20px;
        color: var(--text-light);
    }
    
    .add-post-btn {
        background-color: var(--accent-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }
    
    .add-post-btn:hover {
        background-color: var(--primary-color);
        color: white;
    }
    
    .post-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .post-card {
        background-color: var(--dark-bg);
        border-radius: var(--border-radius);
        overflow: hidden;
    }
    
    .post-header {
        display: flex;
        justify-content: space-between;
        padding: 15px;
        background-color: var(--light-bg);
    }
    
    .post-title {
        font-size: 18px;
        font-weight: 500;
        color: var(--text-light);
    }
    
    .post-date {
        color: var(--text-muted);
        font-size: 14px;
    }
    
    .post-image {
        width: 100%;
        height: 250px;
        background-color: var(--light-bg);
    }
    
    .post-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .post-content {
        padding: 15px;
    }
    
    .post-text {
        color: var(--text-light);
        margin-bottom: 15px;
        line-height: 1.6;
    }
    
    .post-categories {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .category-tag {
        background-color: var(--light-bg);
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .post-actions {
        padding: 15px;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 10px;
    }
    
    .action-btn {
        padding: 5px 10px;
        border-radius: 4px;
        background-color: transparent;
        color: var(--text-light);
        border: 1px solid var(--border-color);
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .action-btn:hover {
        background-color: var(--light-bg);
    }
    
    .empty-posts {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
        background-color: var(--dark-bg);
        border-radius: var(--border-radius);
    }
    
    /* Modal Stilleri */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background-color: var(--dark-bg);
        margin: 5% auto;
        padding: 20px;
        border-radius: var(--border-radius);
        width: 80%;
        max-width: 700px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
        position: relative;
    }
    
    .close-modal {
        color: var(--text-muted);
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 15px;
        top: 10px;
    }
    
    .close-modal:hover {
        color: var(--text-light);
    }
    
    .event-detail {
        margin-top: 15px;
    }
    
    .event-detail-header {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .event-detail-title h2 {
        font-size: 24px;
        color: var(--text-light);
        margin-bottom: 5px;
    }
    
    .event-detail-title p {
        color: var(--text-muted);
        font-size: 14px;
    }
    
    .event-detail-image {
        width: 100%;
        max-height: 350px;
        overflow: hidden;
        margin-bottom: 20px;
        border-radius: var(--border-radius);
        background-color: var(--light-bg);
    }
    
    .event-detail-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .event-detail-description {
        color: var(--text-light);
        line-height: 1.6;
        margin-bottom: 20px;
    }
    
    .modal-categories {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
    }
    
    .post-card {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .post-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .topluluk-link {
        color: var(--text-light);
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .topluluk-link:hover {
        color: var(--primary-color);
        text-decoration: underline;
    }
    
    .post-meta {
        color: var(--text-muted);
        font-size: 14px;
    }
    
    .post-meta a {
        color: var(--text-light);
        font-weight: 500;
    }
</style>

<main class="main-content">
    <div class="content">
        <!-- Topluluk Başlığı -->
        <div class="community-header">
            <div class="community-img">
                <img src="{% static topluluk.get_image_path %}" alt="{{ topluluk.name }}">
            </div>
            <div class="community-info">
                <h2 class="community-name">{{ topluluk.name }}</h2>
                <div class="community-stats">
                    <span>{{ followers_count }} takipçi</span>
                </div>
                <p class="community-description">{{ topluluk.description }}</p>
                
                {% if user.is_authenticated and user.profile.role == "student" %}
                    <button class="follow-btn {% if is_following %}following{% endif %}" data-topluluk="{{ topluluk.id }}" data-action="{% if is_following %}unfollow{% else %}follow{% endif %}">
                        {% if is_following %}
                            <i class="fas fa-user-minus"></i> Takibi Bırak
                        {% else %}
                            <i class="fas fa-user-plus"></i> Takip Et
                        {% endif %}
                    </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Gönderiler Bölümü -->
        <div class="posts-section">
            <div class="section-header">
                <h3 class="section-title">Gönderiler</h3>
                {% if user.is_authenticated and user.username == topluluk.name %}
                    <a href="{% url 'create_post' %}" class="add-post-btn">
                        <i class="fas fa-plus"></i> Yeni Gönderi
                    </a>
                {% endif %}
            </div>
            
            {% if posts %}
                <div class="post-list">
                    {% for post in posts %}
                        <div class="post-card" data-post-id="{{ post.id }}">
                            <div class="post-header">
                                <h4 class="post-title">{{ post.title }}</h4>
                                <span class="post-date">{{ post.created_at|date:"d M Y, H:i" }}</span>
                            </div>
                            
                            {% if post.image %}
                                <div class="post-image">
                                    <img src="{% static post.get_image_path %}" alt="{{ post.title }}">
                                </div>
                            {% endif %}
                            
                            <div class="post-content">
                                <p class="post-text">{{ post.content }}</p>
                                
                                {% if post.categories.all %}
                                    <div class="post-categories">
                                        {% for category in post.categories.all %}
                                            <span class="category-tag">
                                                {% if category.icon %}<i class="fas fa-{{ category.icon }}"></i>{% endif %}
                                                {{ category.name }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            {% if user.is_authenticated and user.username == topluluk.name %}
                                <div class="post-actions">
                                    <a href="{% url 'edit_post' post.id %}" class="action-btn">
                                        <i class="fas fa-edit"></i> Düzenle
                                    </a>
                                    <a href="{% url 'delete_post' post.id %}" class="action-btn">
                                        <i class="fas fa-trash"></i> Sil
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-posts">
                    <p>Bu topluluğun henüz gönderisi bulunmamaktadır.</p>
                </div>
            {% endif %}
        </div>
    </div>
</main>

<script>
    // Takip işlemleri için JavaScript kodları
    document.addEventListener('DOMContentLoaded', function() {
        const followBtn = document.querySelector('.follow-btn');
        
        if (followBtn) {
            followBtn.addEventListener('click', function() {
                const toplulukId = this.getAttribute('data-topluluk');
                const action = this.getAttribute('data-action');
                
                // Form verilerini oluştur
                const formData = new FormData();
                formData.append('topluluk_id', toplulukId);
                formData.append('action', action);
                formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
                
                // AJAX isteği gönder
                fetch('/profiller/api/toggle-follow/', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Butonun görünümünü güncelle
                        if (action === 'follow') {
                            this.setAttribute('data-action', 'unfollow');
                            this.classList.add('following');
                            this.innerHTML = '<i class="fas fa-user-minus"></i> Takibi Bırak';
                        } else {
                            this.setAttribute('data-action', 'follow');
                            this.classList.remove('following');
                            this.innerHTML = '<i class="fas fa-user-plus"></i> Takip Et';
                        }
                        
                        // Takipçi sayısını güncelle
                        const followersCount = document.querySelector('.community-stats span');
                        if (followersCount) {
                            const currentCount = parseInt(followersCount.textContent.split(' ')[0]);
                            const newCount = action === 'follow' ? currentCount + 1 : currentCount - 1;
                            followersCount.textContent = `${newCount} takipçi`;
                        }
                    } else {
                        console.error('Bir hata oluştu:', data.message);
                        alert('Bir hata oluştu: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Hata:', error);
                    alert('İşlem sırasında bir hata oluştu.');
                });
            });
        }
    });
    
    // CSRF token alımı için yardımcı fonksiyon
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<!-- Gönderi Detay Modal -->
<div id="postDetailModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="event-detail">
            <div class="event-detail-header">
                <div class="profile-img medium">
                    <img id="modalCommunityImg" src="{% static 'img/community-icon.jpg' %}" alt="Topluluk">
                </div>
                <div class="event-detail-title">
                    <h2 id="modalTitle"></h2>
                    <div class="post-meta">
                        <p>
                            <a href="{% url 'view_topluluk_profile' topluluk.name %}" class="topluluk-link" onclick="event.stopPropagation();">
                                {{ topluluk.name }}
                            </a> 
                            • <span id="modalDate"></span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="event-detail-image">
                <img id="modalImage" src="" alt="Gönderi Görseli">
            </div>
            <div class="event-detail-description">
                <p id="modalDescription"></p>
            </div>
            <div class="modal-categories" id="modalCategories">
                <!-- Kategoriler buraya gelecek -->
            </div>
        </div>
    </div>
</div>

<script>
    // Modal işlevselliği için JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('postDetailModal');
        const postCards = document.querySelectorAll('.post-card');
        const closeModal = modal.querySelector('.close-modal');
        
        // Gönderi kartlarına tıklama işlevselliği
        postCards.forEach(card => {
            card.addEventListener('click', function(e) {
                // Eğer tıklanan element buton veya link değilse modalı aç
                if (!e.target.closest('.action-btn')) {
                    const postId = this.getAttribute('data-post-id');
                    if (postId) {
                        openPostModal(postId);
                    }
                }
            });
        });
        
        // Modal kapatma
        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        // Dışarı tıklayınca modal kapanır
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Gönderi detaylarını göster
        function openPostModal(postId) {
            fetch(`/topluluklar/api/posts/${postId}/`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Post bulunamadı');
                })
                .then(post => {
                    document.getElementById('modalTitle').textContent = post.title;
                    document.getElementById('modalDate').textContent = post.created_at;
                    
                    // Topluluk resmi kontrolü
                    if (post.topluluk_image) {
                        document.getElementById('modalCommunityImg').src = `{% static 'img/' %}${post.topluluk_image}`;
                    } else {
                        document.getElementById('modalCommunityImg').src = "{% static 'img/community-icon.jpg' %}";
                    }
                    
                    document.getElementById('modalDescription').textContent = post.content;
                    
                    // Gönderi resmi kontrolü
                    if (post.image) {
                        document.getElementById('modalImage').src = `{% static 'img/' %}${post.image}`;
                        document.getElementById('modalImage').style.display = 'block';
                    } else {
                        document.getElementById('modalImage').style.display = 'none';
                    }
                    
                    // Kategorileri ekle
                    const categoriesContainer = document.getElementById('modalCategories');
                    categoriesContainer.innerHTML = '';
                    
                    if (post.categories && post.categories.length > 0) {
                        post.categories.forEach(category => {
                            const categoryTag = document.createElement('span');
                            categoryTag.className = 'category-tag';
                            
                            if (category.icon) {
                                const icon = document.createElement('i');
                                icon.className = `fas fa-${category.icon}`;
                                categoryTag.appendChild(icon);
                            }
                            
                            categoryTag.appendChild(document.createTextNode(' ' + category.name));
                            categoriesContainer.appendChild(categoryTag);
                        });
                    }
                    
                    // Modalı göster
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('Hata:', error);
                });
        }
    });
</script>
{% endblock %} 