{% extends 'layout.html' %}
{% load humanize %}
{% load static %}


{% block content %}
<!-- CSRF token -->
{% csrf_token %}
<main class="main-content">
    <header class="main-header">
        <form action="{% url 'topluluklar' %}" method="GET" class="search-bar centered">
            <input type="text" placeholder="Topluluk ara..." id="community-search" name="q" value="{{ search_query }}">
            <button id="search-button" type="submit"><i class="fas fa-search"></i></button>
        </form>
    </header>

    <div class="content">
        {% if search_query %}
        <div id="search-results" style="margin-top: 20px; text-align: center;">
            <p>"{{ search_query }}" için arama sonuçları: <span id="result-count">{{ topluluklar|length }}</span> topluluk bulundu</p>
            <a href="{% url 'topluluklar' %}" class="small-btn" style="margin-top: 10px; display: inline-block; text-decoration: none;">Temizle</a>
        </div>
        {% else %}
        <div id="search-results" style="display: none; margin-top: 20px; text-align: center;">
            <p>Arama sonuçları: <span id="result-count">0</span> topluluk bulundu</p>
            <button id="clear-search" class="small-btn" style="margin-top: 10px;">Temizle</button>
        </div>
        {% endif %}

        <div class="community-grid">
            {% if topluluklar %}
            {% for topluluk in topluluklar %}
            <div class="community-card" data-name="{{ topluluk.name|lower }}" data-category="teknoloji" data-id="{{ topluluk.id }}">
                <div class="card-header">
                    <div class="profile-img medium">
                        <img src="{% static topluluk.get_image_path %}" alt="Topluluk">
                    </div>
                    <h3>{{ topluluk.name }}</h3>
                </div>
                <div class="card-rating">
                    <span class="stars">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                    </span>
                    <span class="rating-count">(42)</span>
                </div>
                <p>{{ topluluk.description }}</p>
                <div class="card-actions">
                    <button class="small-btn follow-button" data-id="{{ topluluk.id }}">
                        <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                        <span class="follow-text">Takip Et</span>
                    </button>
                    <a href="{% url 'view_topluluk_profile' topluluk.name %}" class="icon-btn view-details">
                        <i class="fas fa-info-circle"></i>
                    </a>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h3>{% if search_query %}Arama sonucu bulunamadı{% else %}Henüz hiç topluluk eklenmemiş{% endif %}</h3>
                <p>{% if search_query %}Aramanızı değiştirerek tekrar deneyin{% else %}Yakında topluluklar burada listelenecek{% endif %}.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Bildirim Toast -->
    <div id="notification-toast" style="display: none; position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 16px; border-radius: 4px; z-index: 1000; max-width: 300px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
        <span id="notification-message"></span>
        <button style="position: absolute; right: 10px; top: 10px; background: transparent; border: none; color: white; cursor: pointer;" onclick="document.getElementById('notification-toast').style.display='none';">×</button>
    </div>
</main>

{% if not search_query %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('community-search');
        const searchButton = document.getElementById('search-button');
        const clearSearchButton = document.getElementById('clear-search');
        const searchResults = document.getElementById('search-results');
        const resultCount = document.getElementById('result-count');
        const communityCards = document.querySelectorAll('.community-card');
        
        // Arama fonksiyonu
        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            let matchCount = 0;
            
            // Arama teriminin uzunluğunu kontrol et
            if (searchTerm.length === 0) {
                // Arama kutusu boşsa, tüm toplulukları göster
                communityCards.forEach(card => {
                    card.style.display = 'block';
                });
                
                searchResults.style.display = 'none';
                return;
            }
            
            // Her topluluk kartını kontrol et
            communityCards.forEach(card => {
                const name = card.getAttribute('data-name');
                const description = card.querySelector('p').textContent.toLowerCase();
                
                // İsim veya açıklamada arama terimi var mı?
                if (name.includes(searchTerm) || description.includes(searchTerm)) {
                    card.style.display = 'block';
                    matchCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Sonuçları göster
            resultCount.textContent = matchCount;
            searchResults.style.display = 'block';
        }
        
        // Aramayı temizle
        function clearSearch() {
            searchInput.value = '';
            communityCards.forEach(card => {
                card.style.display = 'block';
            });
            searchResults.style.display = 'none';
        }
        
        // Event listener'ları ekle
        searchInput.addEventListener('input', performSearch);
        searchButton.addEventListener('click', function(e) {
            // Arama kutusu boşsa ve tıklandıysa, sayfa yenilenmesini engelle
            if (searchInput.value.trim().length === 0) {
                e.preventDefault();
                performSearch();
            }
        });
        clearSearchButton.addEventListener('click', clearSearch);
    });
</script>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // CSRF token al
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Tüm takip butonlarını seç
        const followButtons = document.querySelectorAll('.follow-button');
        
        // Her takip butonu için event listener ekle
        followButtons.forEach(button => {
            const toplulukId = button.getAttribute('data-id');
            const followText = button.querySelector('.follow-text');
            const spinner = button.querySelector('.fa-spinner');
            
            // İlk yüklemede takip durumunu kontrol et
            fetch(`/profiller/api/check-follow/${toplulukId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.following) {
                        followText.textContent = 'Takibi Bırak';
                        button.classList.add('following');
                    } else {
                        followText.textContent = 'Takip Et';
                        button.classList.remove('following');
                    }
                })
                .catch(error => console.error('Takip durumu kontrol edilemedi:', error));
            
            // Takip/Takibi bırak butonuna tıklama olayı
            button.addEventListener('click', function() {
                // Spinner'ı göster, metni gizle
                spinner.style.display = 'inline-block';
                followText.style.visibility = 'hidden';
                
                // Form verilerini hazırla
                const formData = new FormData();
                formData.append('topluluk_id', toplulukId);
                formData.append('csrfmiddlewaretoken', csrftoken);
                
                // API'ye istek gönder
                fetch('/profiller/api/toggle-follow/', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    // Spinner'ı gizle, metni göster
                    spinner.style.display = 'none';
                    followText.style.visibility = 'visible';
                    
                    // Başarılı ise buton metnini güncelle
                    if (data.status === 'success') {
                        if (data.following) {
                            followText.textContent = 'Takibi Bırak';
                            button.classList.add('following');
                        } else {
                            followText.textContent = 'Takip Et';
                            button.classList.remove('following');
                        }
                        
                        // Bildirim göster
                        showNotification(data.message);
                    } else {
                        showNotification('Bir hata oluştu: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Takip işlemi sırasında hata:', error);
                    spinner.style.display = 'none';
                    followText.style.visibility = 'visible';
                    showNotification('Bir hata oluştu, lütfen tekrar deneyin.', 'error');
                });
            });
        });
        
        // Bildirim gösterme fonksiyonu
        function showNotification(message, type = 'success') {
            const toast = document.getElementById('notification-toast');
            const toastMessage = document.getElementById('notification-message');
            
            toastMessage.textContent = message;
            
            // Bildirim tipine göre renk değiştir
            if (type === 'error') {
                toast.style.backgroundColor = '#F44336';
            } else {
                toast.style.backgroundColor = '#4CAF50';
            }
            
            // Bildirimi göster
            toast.style.display = 'block';
            
            // 5 saniye sonra otomatik kapat
            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
        }
    });
</script>
{% endblock %}